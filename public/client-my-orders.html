<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø·Ù„Ø¨Ø§ØªÙŠ | ÙˆØµÙ„-Ù„ÙŠ</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;900&display=swap" rel="stylesheet">
    <style>
        .order-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-right: 5px solid #ddd;
            transition: 0.3s;
        }
        .order-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª */
        .status-pending { border-right-color: #f39c12; }   /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
        .status-accepted { border-right-color: #3498db; }  /* Ø£Ø²Ø±Ù‚ */
        .status-delivered { border-right-color: #27ae60; } /* Ø£Ø®Ø¶Ø± */
        .status-cancelled { border-right-color: #e74c3c; } /* Ø£Ø­Ù…Ø± */

        .status-badge {
            display: inline-block; padding: 5px 10px; border-radius: 15px;
            font-size: 12px; font-weight: bold; color: white;
        }
        .bg-pending { background-color: #f39c12; }
        .bg-accepted { background-color: #3498db; }
        .bg-delivered { background-color: #27ae60; }
        .bg-cancelled { background-color: #e74c3c; }

        .order-route { display: flex; align-items: center; gap: 10px; margin: 15px 0; font-size: 14px; }
        .arrow { color: #aaa; font-size: 18px; }
        .price-tag { font-weight: bold; color: var(--primary); font-size: 1.1rem; }
    </style>
</head>
<body style="background-color: #f4f6f9;">

    <header>
        <a href="" class="logo">
    <img src="logo.png" alt="Ø´Ø¹Ø§Ø± ÙˆØµÙ„-Ù„ÙŠ"> </a>
        <nav class="nav-links">
            <a href="client-orders.html" class="btn-main">â• Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</a>
        </nav>
    </header>

    <div class="dashboard-container">
        <h2 style="font-family:'Cairo'; text-align:center; margin-bottom:30px;">ğŸ“¦ Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
        
        <div id="orders-list">
            <p style="text-align:center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
        </div>
    </div>

<script>
    const token = localStorage.getItem('clientToken');
    if (!token) window.location.href = 'client-login.html';

    async function loadOrders() {
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
            const res = await fetch('/api/orders/my-orders', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const orders = await res.json();
            
            const container = document.getElementById('orders-list');
            container.innerHTML = '';

            if (orders.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#777; background:white; border-radius:10px;">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø© ğŸ“­ <br><br> <a href="client-orders.html" style="color:var(--primary);">Ø§Ø¨Ø¯Ø£ Ø¨Ø·Ù„Ø¨ ÙƒØ§Ø¨ØªÙ† Ø§Ù„Ø¢Ù†</a></div>';
                return;
            }

            orders.forEach(order => {
                const statusMap = {
                    'pending': { text: 'â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©', class: 'status-pending', bg: 'bg-pending' },
                    'accepted': { text: 'ğŸš´â€â™‚ï¸ Ø§Ù„ÙƒØ§Ø¨ØªÙ† ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚', class: 'status-accepted', bg: 'bg-accepted' },
                    'delivered': { text: 'âœ… ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„', class: 'status-delivered', bg: 'bg-delivered' },
                    'cancelled': { text: 'âŒ Ù…Ù„ØºÙŠ', class: 'status-cancelled', bg: 'bg-cancelled' }
                };

                const st = statusMap[order.status] || statusMap['pending'];
                const date = new Date(order.createdAt).toLocaleDateString('ar-EG');
                const pickupAddr = order.pickup ? order.pickup.address : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const dropoffAddr = order.dropoff ? order.dropoff.address : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

                // ğŸ”¥ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡: ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© pending
                let cancelButton = '';
                if (order.status === 'pending') {
                    cancelButton = `
                        <button onclick="cancelOrder('${order._id}')" 
                                style="background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:12px; margin-top:10px;">
                            âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨
                        </button>
                    `;
                }

                const html = `
                    <div class="order-card ${st.class}">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <span class="status-badge ${st.bg}">${st.text}</span>
                            <span style="font-size:12px; color:#777;">${date}</span>
                        </div>
                        
                        <div class="order-route">
                            <span style="font-weight:bold;">ğŸŸ¢ ${pickupAddr}</span>
                            <span class="arrow">â¬…ï¸</span>
                            <span style="font-weight:bold;">ğŸ ${dropoffAddr}</span>
                        </div>

                        <div style="font-size:13px; color:#555; margin-bottom:10px; background:#f9f9f9; padding:10px; border-radius:5px;">
                            ğŸ“ ${order.details}
                        </div>

                        <div style="border-top:1px solid #eee; padding-top:10px; display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <span class="price-tag">${order.price} Ø¬Ù†ÙŠÙ‡</span>
                                <div style="font-size:12px; color:#777;">Ø§Ù„Ù…Ø³Ø§ÙØ©: ${translateDistance(order.distanceType)}</div>
                            </div>
                            ${cancelButton} </div>
                    </div>
                `;
                container.innerHTML += html;
            });

        } catch (err) {
            console.error(err);
            document.getElementById('orders-list').innerHTML = '<p style="color:red; text-align:center;">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>';
        }
    }

    // Ø¯Ø§Ù„Ø© ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù…Ø³Ø§ÙØ©
    function translateDistance(type) {
        if(type === 'short') return 'Ù‚Ø±ÙŠØ¨';
        if(type === 'medium') return 'ÙˆØ³Ø·';
        if(type === 'long') return 'Ø¨Ø¹ÙŠØ¯';
        return type;
    }

    // ğŸ”¥ Ø¯Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    async function cancelOrder(orderId) {
        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;

        try {
            const res = await fetch(`http://localhost:5000/api/orders/${orderId}/cancel`, {
                method: 'PUT',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();

            if (res.ok) {
                alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
                loadOrders(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
            } else {
                alert(data.message);
            }
        } catch (err) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
        }
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    loadOrders();
</script>

</body>
</html>
