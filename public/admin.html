<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | ÙˆÙØµÙÙ‘Ù„ÙÙŠ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; margin: 0; direction: rtl; }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar { width: 250px; background: #2c3e50; color: white; height: 100vh; position: fixed; padding: 20px; box-sizing: border-box; }
        .sidebar h2 { text-align: center; margin-bottom: 30px; color: #ecf0f1; }
        .sidebar button { width: 100%; padding: 12px; background: transparent; color: white; border: 1px solid rgba(255,255,255,0.2); margin-bottom: 10px; cursor: pointer; text-align: right; border-radius: 5px; transition: 0.3s; }
        .sidebar button:hover { background: rgba(255,255,255,0.1); }
        .sidebar .logout { background: #c0392b; border: none; margin-top: 20px; text-align: center; }
        
        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .content { margin-right: 250px; padding: 30px; }
        
        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid #3498db; }
        .card h3 { margin: 0; color: #7f8c8d; font-size: 14px; }
        .card .number { font-size: 32px; font-weight: bold; color: #2c3e50; margin: 10px 0; }
        .card.revenue { border-bottom-color: #27ae60; }
        .card.revenue .number { color: #27ae60; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        h2.section-title { margin-top: 40px; margin-bottom: 15px; color: #34495e; border-bottom: 2px solid #ddd; padding-bottom: 10px; display: inline-block; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        th, td { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #34495e; color: white; font-weight: normal; }
        tr:hover { background-color: #f9f9f9; }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .btn-toggle { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 14px; }
        .btn-active { background-color: #e74c3c; } /* Ù„ÙˆÙ† Ø²Ø± Ø§Ù„ØªØ¹Ø·ÙŠÙ„ */
        .btn-inactive { background-color: #27ae60; } /* Ù„ÙˆÙ† Ø²Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„ */
        
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .active-badge { background: #e8f8f5; color: #27ae60; }
        .inactive-badge { background: #fdedec; color: #e74c3c; }

    </style>
</head>
<body>

    <div class="sidebar">
        <h2>ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
        <p style="text-align: center; font-size: 14px; opacity: 0.7;">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</p>
        <hr style="opacity: 0.2;">
        
        <button onclick="scrollToSection('stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        <button onclick="scrollToSection('users')">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
        <button onclick="scrollToSection('orders')">ğŸ“¦ Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        
        <button class="logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸ”’</button>
    </div>

    <div class="content">
        
        <div id="stats">
            <h1>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h1>
            <div class="stats-grid">
                <div class="card">
                    <h3>ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                    <div class="number" id="count-customers">...</div>
                </div>
                <div class="card">
                    <h3>ğŸš´â€â™‚ï¸ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ¨Ø§ØªÙ†</h3>
                    <div class="number" id="count-captains">...</div>
                </div>
                <div class="card">
                    <h3>ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
                    <div class="number" id="count-orders">...</div>
                </div>
                <div class="card revenue">
                    <h3>ğŸ’° Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø­Ù‚Ù‚Ø©</h3>
                    <div class="number" id="total-revenue">...</div>
                </div>
            </div>
        </div>

        <h2 class="section-title" id="users">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø§Ù„ÙƒØ¨Ø§ØªÙ† ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡)</h2>
        <table id="usersTable">
            <thead>
                <tr>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                    <th>Ø§Ù„Ø¯ÙˆØ±</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="5">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
            </tbody>
        </table>

        <h2 class="section-title" id="orders">ğŸ“¦ Ø¢Ø®Ø± 5 Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
        <table id="ordersTable">
            <thead>
                <tr>
                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th>Ø§Ù„ÙƒØ§Ø¨ØªÙ†</th>
                    <th>Ù…Ù†</th>
                    <th>Ø¥Ù„Ù‰</th>
                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="6">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
            </tbody>
        </table>

    </div>

    <script>
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ† (Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = 'admin-login.html'; // ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„ØµØ­ÙŠØ­Ø©
        }

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø© (Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯)
        async function loadDashboard() {
            try {
                // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª
                const resStats = await fetch('http://localhost:5000/api/admin/dashboard', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (resStats.status === 403) {
                    alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„!");
                    logout();
                    return;
                }
                
                const data = await resStats.json();

                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                document.getElementById('count-customers').innerText = data.stats.customers;
                document.getElementById('count-captains').innerText = data.stats.captains;
                document.getElementById('count-orders').innerText = data.stats.orders;
                document.getElementById('total-revenue').innerText = data.stats.revenue + ' Ø¬.Ø³';

                // ØªØ¹Ø¨Ø¦Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                const ordersBody = document.querySelector('#ordersTable tbody');
                ordersBody.innerHTML = '';
                data.recentOrders.forEach(order => {
                    ordersBody.innerHTML += `
                        <tr>
                            <td>${order.customer ? order.customer.name : 'Ù…Ø¬Ù‡ÙˆÙ„'}</td>
                            <td>${order.captain ? order.captain.name : '---'}</td>
                            <td>${order.pickupLocation}</td>
                            <td>${order.dropoffLocation}</td>
                            <td>${order.price}</td>
                            <td>${translateStatus(order.status)}</td>
                        </tr>
                    `;
                });

            } catch (err) {
                console.error(err);
            }
        }

        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)
        async function loadUsers() {
            try {
                const resUsers = await fetch('http://localhost:5000/api/admin/users', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const users = await resUsers.json();
                
                const usersBody = document.querySelector('#usersTable tbody');
                usersBody.innerHTML = '';

                users.forEach(user => {
                    if (user.role === 'admin') return; // Ù„Ø§ ØªØ¹Ø±Ø¶ Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©

                    usersBody.innerHTML += `
                        <tr>
                            <td>${user.name}</td>
                            <td>${user.phone}</td>
                            <td>
                                <span style="font-weight:bold; color:${user.role === 'captain' ? '#d35400' : '#2980b9'}">
                                    ${user.role === 'captain' ? 'ğŸš´â€â™‚ï¸ ÙƒØ§Ø¨ØªÙ†' : 'ğŸ‘¤ Ø¹Ù…ÙŠÙ„'}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge ${user.isActive ? 'active-badge' : 'inactive-badge'}">
                                    ${user.isActive ? 'Ù†Ø´Ø·' : 'Ù…Ø¹Ø·Ù„'}
                                </span>
                            </td>
                            <td>
                                <button class="btn-toggle ${user.isActive ? 'btn-active' : 'btn-inactive'}" 
                                        onclick="toggleUserStatus('${user._id}')">
                                    ${user.isActive ? 'ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨' : 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨'}
                                </button>
                            </td>
                        </tr>
                    `;
                });

            } catch (err) {
                console.error(err);
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„)
        async function toggleUserStatus(id) {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) return;

            try {
                const res = await fetch(`http://localhost:5000/api/admin/user/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (res.ok) {
                    loadUsers(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                    loadDashboard(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ù‚Ø¯ ÙŠØªØºÙŠØ± Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø´Ø·)
                } else {
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£");
                }
            } catch (err) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
            }
        }

        function translateStatus(status) {
            const map = {
                'pending': 'â³ Ø§Ù†ØªØ¸Ø§Ø±',
                'accepted': 'ğŸš´â€â™‚ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„',
                'delivered': 'âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…',
                'cancelled': 'âŒ Ù…Ù„ØºÙŠ'
            };
            return map[status] || status;
        }

        function scrollToSection(id) {
            document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
        }

        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = 'admin-login.html';
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        loadDashboard();
        loadUsers();

    </script>

</body>
</html>